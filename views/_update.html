<html>
<head>
    <title>Update</title>
<!--    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.8.2/css/all.min.css">-->
    <link type="text/css" rel="stylesheet" href="fontawesome/css/all.min.css">
    <link type="text/css" rel='stylesheet' href='css/bootstrap.min.css'/>
    <link type="text/css" rel='stylesheet' href='css/mdb.min.css'/>
    <link type="text/css" rel='stylesheet' href='css/style.css'/>

    <style>
        .content {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .icon {
            width: 60px;
            height: 60px;
        }

        .right {
            width: 400px;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
        }

        .right .msg > div {
            display: flex;
            flex-direction: row;
            align-items: start;
        }
    </style>
</head>
<body>
<div class="content">
    <img src="img/ic_logo.64.png" class="icon ms-2"/>
    <div class="right ps-4">
        <div class="msg">
            <p>发现新版本，是否下载</p>
            <div>
                <button id="cancel" class="btn btn-light">取消</button>
                <button id="submit" class="btn btn-primary ms-2">立即下载</button>
            </div>
        </div>
        <div class="progress" style="height: 20px; width: 350px">
            <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
            </div>
            <div class="desc"></div>
        </div>
    </div>
</div>
<script>if (typeof module === 'object') {
    window.module = module;
    module = undefined;
}</script>
<script src="js/jquery.min.js" type="text/javascript"></script>
<script src="js/bootstrap.min.js" type="text/javascript"></script>
<script src="js/mdb.min.js" type="text/javascript"></script>
<script>if (window.module) module = window.module;</script>
<script src="values/strings.js" type="text/javascript"></script>
<script src="js/status.js" type="text/javascript"></script>

<script>
    let lab = $('p')
    let layoutMsg = $('.msg'), layoutProgress = $('.progress')
    let $btnCel = $('#cancel'), $btnSub = $('#submit'), $progressBar = $('.progress-bar')
    $btnCel.html(string('versionCancel'))
    $btnCel.click(() => window.api.send('toMain', ['version.cancel']))
    let info
    window.api.receive('fromMain', function (args) {
        switch (args[0]) {
            case 'err':
                break
            case 'new':
                info = args[1]
                layoutMsg.show()
                layoutProgress.hide()
                lab.html(`${string('versionNew')}${info.version}，${string('versionUpdateReq')}`)
                $btnSub.html(`<i class="fas fa-download me-1"></i>${string('versionDownload')}`)
                $btnSub.click(e => {
                    window.api.send('toMain', ['version.download'])
                    btnLoading($(e.target))
                })
                break
            case 'progress':
                layoutMsg.hide()
                layoutProgress.show()
                let progress = args[1]
                let percent = progress.percent.toFixed(2)
                $progressBar.css('width', `${percent}%`)
                $progressBar.attr('aria-valuenow', `${progress.percent.toFixed(0)}`)
                $progressBar.html(`${percent}%  (${formatT(progress.transferred)}/${formatT(progress.total)})`)
                console.log(JSON.stringify(progress))
                break
            case 'finish':
                btnRecoverAll()
                layoutMsg.show()
                layoutProgress.hide()
                lab.html(`${string('versionInstallReq')}`)
                $btnSub.html(`<i class="fas fa-sign-in-alt me-1"></i>${string('versionInstall')}`)
                $btnSub.click(e => {
                    window.api.send('toMain', ['version.install'])
                    btnLoading($(e.target))
                })
                break
        }
    })

    function formatT(traffic) {
        // MB
        let flow = traffic / 1024 / 1024
        // 小于1G
        if (flow < 1024) {
            return flow.toFixed(2) + 'MB'
        }
        if (flow < 1024 * 1024) {
            return (flow / 1024).toFixed(2) + 'GB'
        }
        return (flow / 1024 / 1024).toFixed(2) + 'TB'
    }
</script>
</body>
</html>